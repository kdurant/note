# 10.1 概述
传输层不需要知道如何传输和接收帧。传输层简单地构造用于传输的帧信息结构（FIS）并且解析所接收的帧信息结构。主机和设备传输层状态不同，因为FIS内容的来源不同。传输层在ATA命令或以前的FIS内容方面不保持上下文。

## 10.1.1 FIS构造
当更高层要求构造FIS时，传输层提供以下服务：
1. 根据请求的FIS类型收集FIS内容。
2. 照正确的顺序放置FIS内容。
3. 通知所需帧传输的链路层，并将FIS内容传递给链路。
4. 管理缓冲区/ FIFO流程，通知Link需要的流控制。
5. 从链路层接收帧接收确认。
6. 根据更高层要求报告传输状态


## 10.1.2 FIS分解
当从链路层接收到FIS时，传输层提供以下服务：
1. 从链接层接收FIS。
2. 确定FIS类型。
3. 将FIS内容分发到FIS类型指示的位置。
4. 对于主机传输层，收到FIS也可能导致将FIS的构建返回到设备。
5. 根据更高层要求报告传输状态

# 10.2 帧信息（FIS）
## 10.2.1 概述
FIS是一组如前所述的在主机和设备之间传递信息的双字。原语用于定义FIS的边界，并可以插入以控制信息流的速度。 本部分描述了FIS的信息内容 - 被称为有效载荷 - 并且假设读者意识到支持信息内容所需的原语

本部分描述的FIS的信息内容 - 被称为有效载荷 - 并且假设读者意识到支持信息内容所需的原语。

信息字段的内容分为三类：（1）寄存器类型，（2） 设置类型，（3）数据类型。 对于每个类别，每个框架的组织在下一节中定义。

## 10.2.2 有效载荷内容
有效载荷的类型和布局由位于有效载荷的第一个双字节的字节0中的帧信息类型字段指示。
![](https://github.com/kdurant/sata_controller/blob/master/doc/pic/ch10/Figure194.png?raw=true)

此示例类型主要用于将影子寄存器块寄存器的内容从主机传输到设备。

可以引用 Table 73 来刷新读取器对ATA适配器的影子寄存器块组织的简化版本的存储器。

以下部分详细介绍了可能的有效载荷类型。 SOFP，EOFP和HOLDP原语已被清除。

# 10.3 FIS类型
以下部分定义了每个FIS的结构

## 10.3.1 FIS类型值

所有FIS类型字段的值已经提供额外的稳定性。

在可能不缓存完整FIS的最小缓冲实现中，状态机可以在结束CRC被检查之前开始根据所接收的FIS类型值进行操作。

因为FIS类型值可以在完整FIS的完整性之前对其终止CRC进行检查，所以已经选择了FIS类型字段值以最大化它们之间的Hamming距离

Figure 193 列举了FIS类型值及其赋值
![](https://github.com/kdurant/sata_controller/blob/master/doc/pic/ch10/Figure193.png?raw=true)

### 10.3.1.1 未认证的FIS类型
设备或主机可能会收到未在图193中定义或供应商特定的FIS类型。

FIS的接收者决定是否处理未定义或保留为“无法识别”的FIS类型。

接收者可能会接受未定义的或供应商特定的FIS。 主机和设备应该协商任何未定义的或供应商特定的FIS类型，在使用之前可能会被传输。

如果接收方决定将FIS类型视为无法识别，则应在接收到该FIS类型后，按照第9.6节中的链路层状态机定义进行操作。

## 10.3.2 FIS数据CRC错误
在数据FIS上发生串行ATA CRC错误之后，如果是设备发Device-to-Host FIS，则应将ERR位设置为1，并且在状态字段中将BSY位和DRQ位清零，并且ABRT位 在错误字段中设置为1。建议设备在错误字段中将bit7（即ICRC位）设置为1。参见ATA8-ACS。
There is no Device-to-Host FIS transmitted after a Serial ATA CRC error on the last Data FIS of a PIO-in command nor following a Serial ATA CRC error on the ATAPI command packet transfer.
因此，在任何一种情况下，设备都没有向主机指示串行ATA CRC错误的机制。

主机应检查SError寄存器以确定在这两种情况下是否发生链路层错误。

## 10.3.3 所有FIS类型
在以下所有FIS结构中，应适用下列规则：
1. 所有保留的字段应作为全零写入或传输
2. 在读取或接收过程中，所有保留字段应被忽略。

## 10.3.4 Host to Device 寄存器
如果这个FIS中的一个字段没有被命令定义，那么它应该被保留用于该命令

字段定义:
1. FIS类型 - 设置为27h的值。定义其余的FIS字段。将FIS的长度定义为五个Dword
2. C - 当寄存器传送是由于命令寄存器的更新而产生时，该位被置1。当寄存器传输是由于器件控制寄存器的更新导致的，该位清零。将“设备控制字段中的C位设置为1并将SRST位设置为1是无效的，并导致不确定的行为。

3. 命令 - 包含影子寄存器块的命令寄存器的内容。
4. LBA（7：0） - 包含影子寄存器块的LBA低位寄存器的内容。
5. 控制 - 包含影子寄存器块的设备控制寄存器的内容。
6. LBA（15：8） - 包含影子寄存器块的LBA Mid寄存器的内容。
7. LBA（39:32） - 包含阴影寄存器块的扩展地址字段的内容
8.  LBA（47:40） - 包含阴影寄存器块的扩展地址字段的内容
9. 设备 - 包含影子寄存器块的设备寄存器的内容。
10. 特性（7：0） - 包含影子寄存器块的特性寄存器的内容。
11. 功能（15：8） - 包含阴影寄存器块的扩展地址字段的内容
12. PM端口 - 当端点设备通过端口倍增器连接时，指定FIS应传送到的设备端口地址。该字段由主机设置。
13. R - 保留 - 应清零。
14. 计数（7：0） - 包含影子寄存器块的扇区计数寄存器的内容。
15. 计数（15：8） - 包含阴影寄存器块的扩展地址字段的内容
16. LBA（7：0） - 包含影子寄存器块的LBA低位寄存器的内容。

17. LBA（31:24） - 包含阴影寄存器块的扩展地址字段的内容

18. ICC - 等时命令完成（ICC）包含一个由主机设置的值来通知设备一个时间限制。 如果一个命令没有定义这个字段的使用，它应该被保留。

### 10.3.4.1 描述
寄存器 - 主机到设备FIS用于将阴影寄存器块的内容从主机传送到设备。 这是向设备发出ATA命令的机制。

### 10.3.4.2 传输
寄存器 - Host to Device FIS的传输是通过对命令寄存器进行写操作或向设备控制寄存器写入一个与当前在主机适配器的影子寄存器块中的设备控制寄存器中不同的值。
在开始发送时，发送影子寄存器块的当前内容，并根据发送是由命令寄存器被写入还是设备控制寄存器被写入来设置FIS中的C位。

主机适配器应将映射状态寄存器中的BSY位设置为在启动发送的命令寄存器的写操作的400 ns内。

如果对器件控制寄存器的写操作将SRST位的状态从零变为1，则主器件适配器应在对器件控制寄存器的写操作的400ns内将阴影状态寄存器中的BSY位置1。

主机适配器不应将影子状态寄存器中的BSY位设置为写入器件控制寄存器，而不会将SRST位的状态从零变为1。

需要注意的是，串行ATA主机适配器强制执行与并行ATA设备对命令块寄存器执行的影子寄存器块相同的访问控制。

具体来说，主机被禁止写入功能（7：0），计数（7：0），LBA（7：0），LBA（15：8），LBA（23:16），或设备寄存器当BSY位或DRQ位在状态寄存器中设置。

当BSY位或DRQ位置1时，任何写命令寄存器的写操作都将被忽略，除非写操作发出一个器件复位命令。

### 10.3.4.3 接收


在接收到有效的寄存器 - Host to Device FIS 时，设备更新其命令和控制块寄存器内容的本地副本。

然后，根据FIS中C位的状态，器件启动执行命令寄存器中指示的命令或启动执行设备控制寄存器中指示的控制请求。

有传统的BIOS和驱动程序写入设备控制寄存器以在发出命令之前启用中断。

为了避免不必要的开销，只有在从前一个值改变状态时才将该FIS传送到设备。

## 10.3.5 Device to Host
![](https://github.com/kdurant/sata_controller/blob/master/doc/pic/ch10/Figure195.png?raw=true)

字段定义：
FIS类型 - 设置为34h的值。 定义其余的FIS字段。 将FIS的长度定义为五个Dword。

LBA（15：8） - 包含影子寄存器块的LBA Mid寄存器的新值。
LBA（39:32） - 包含阴影寄存器块的扩展地址字段的内容
LBA（23:16） - 包含影子寄存器块的LBA高位寄存器的新值。
LBA（47:40） - 包含阴影寄存器块的扩展地址字段的内容
设备 - 包含影子寄存器块的设备寄存器的新值。
错误 - 包含影子寄存器块的错误寄存器的新值。

I - 中断位。 该位反映设备的中断位线。 设备不应该根据寄存器主机到设备FIS的nIEN位的状态来修改该位的行为。

PM端口 - 当端点设备通过端口倍增器连接时，指定从中接收FIS的设备端口地址。 该字段由端口倍增器设置。 终端设备应将此字段设置为0h。

R - 保留， - 应清零。
Count（7：0） - 包含影子寄存器块的扇区计数寄存器的新值。
Count（15：8） - 包含阴影寄存器块的扩展地址字段的内容
LBA（7：0） - 包含影子寄存器块的LBA低位寄存器的新值。
LBA（31:24） - 包含阴影寄存器块的扩展地址字段的内容
Status - 包含影子寄存器块的状态（和备用状态）寄存器的新值。

### 10.3.5.1 描述
The Register  - 设备到主机FIS被设备用来更新主机适配器的影子寄存器块的内容。 这是设备指示命令完成状态或以其他方式更改主机适配器的影子寄存器块的内容的机制。

### 10.3.5.2 传输